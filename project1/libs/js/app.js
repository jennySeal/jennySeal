import{jawgKey}from"./config.js";const country={iso2:"",iso3:"",population:0,countryName:"",currency:"",capital:"",geonameId:0,flag:"",area:0,currentHours:0,currentMinutes:0,mintemp:0,maxtemp:0,windspeed:0,weathericon:"",humidity:0,weatherDescription:"",confirmedCovidCases:0,criticalCovidcases:0,totalCovidDeaths:0,USDexchange:0,EURexchange:0,newsTitle:"",newsTitle2:"",newsTitle3:"",newsTitle4:"",newsLink:"",newsLink2:"",newsLink3:"",newsLink4:"",newsImage:"",newsImage2:"",newsImage3:"",newsImage4:"",officialName:"",demonym:"",currencyName:"",currencySymbol:"",languages:[],worldBankRating:"",lifeExpectancy:"",north:0,south:0,east:0,west:0};let polyGonLayer,wikiMarkerLayer,earthquakeMarkerLayer,regionMarkerLayer,capitalMarker,youAreHereMarker,circleMarker,mapOptions,centerOnLat,centerOnLong,clickLocationLat=0,clickLocationLng=0,timeoffset=0,screenCheck=window.matchMedia("(min-width: 400px)"),geoJsonFeature={type:"loading"};const earthquakeMarkers=L.markerClusterGroup(),wikiMarkers=L.markerClusterGroup(),regionMarkers=L.markerClusterGroup();$(document).ready(function(){$(".spinner-wrapper").length&&$(".spinner-wrapper").delay(3e3).fadeOut(3e3,function(){$(".spinner-wrapper").remove()})});const map=L.map("map").fitWorld(),mapDesign=L.tileLayer("https://tile.jawg.io/jawg-sunny/{z}/{x}/{y}{r}.png?access-token={accessToken}",{attribution:'<a href="http://jawg.io" title="Tiles by  Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',minZoom:0,maxZoom:22,subdomains:"abcd",accessToken:jawgKey,crossOrigin:""});mapDesign.addTo(map);const onLocationFound=e=>{clickLocationLat=e.latlng.lat,clickLocationLng=e.latlng.lng;const t=e.accuracy/2;let a=L.ExtraMarkers.icon({icon:"fa-map-pin",markerColor:"red",shape:"circle",prefix:"fa"});(youAreHereMarker=L.marker(e.latlng,{icon:a})).bindPopup("&#x1F30E You are here!").openPopup().addTo(map),circleMarker=L.circleMarker(e.latlng,t).addTo(map),initialiseMaps(clickLocationLat,clickLocationLng)},onLocationError=e=>{initialiseMaps(clickLocationLat=51.50853,clickLocationLng=-.12574)};map.on("locationfound",onLocationFound),map.on("locationerror",onLocationError),map.locate({setView:"{clickLocationLat, clickLocationLng}",maxZoom:5}),map.on("dblclick",function(e){clickLocationLat=e.latlng.lat,clickLocationLng=e.latlng.lng,initialiseMaps(clickLocationLat,clickLocationLng)}),$("#countrySelect").change(function(){country.iso2=$("#countrySelect option:selected").val(),getData()});const initialiseMaps=(e,t)=>{getSelectData(),getCountryCode(e,t)},getData=()=>{"loading"!==geoJsonFeature.type&&resetMap(),callApi("getCountryInfo","en",country.iso2,getBasicData),callApi("getPolygon",country.iso2,"",displayPolygon)},getCountryCode=(e,t)=>{callApi("getCountryCode",e,t,useCountryCode)},useCountryCode=e=>{$("#countrySelect").val(`${e.data}`).change()};$("#closeModal").click(function(){$(".modal").slideUp("slow",function(){})}),L.easyButton("far fa-flag",function(){resetModal(),displayTopLevel(),$(".modal").slideDown("slow",function(){})}).addTo(map),L.easyButton("fas fa-rainbow",function(){resetModal(),callApi("getWeather",country.capital,"metric",getWeatherData),$(".modal").slideDown("slow",function(){})}).addTo(map),L.easyButton("fas fa-heartbeat fa",function(){resetModal(),callApi("getVirus",country.iso2,"",getVirusData),$(".modal").slideDown("slow",function(){})}).addTo(map),L.easyButton("fas fa-money-bill-alt",function(){resetModal(),callApi("getMoney",country.currency,"",getMoneyData),$(".modal").slideDown("slow",function(){})}).addTo(map),L.easyButton("far fa-newspaper",function(){resetModal(),callApi("getNews",country.iso2,country.demonym,getNews),$(".modal").slideDown("slow",function(){})}).addTo(map),L.easyButton("fas fa-search-minus",function(){map.setView([centerOnLat,centerOnLong],5)}).addTo(map);const getSelectData=()=>{callApi("getSelectData","","",displaySelectData)},displaySelectData=e=>{const t=e.data;for(let e=0;e<t.length;e++){const a=t[e][0],n=t[e][1];$("#countrySelect").append(`<option value="${n}">${a}</option>`)}},getBasicData=e=>{const t=e.data[0];country.north=t.north,country.south=t.south,country.east=t.east,country.west=t.west,country.geonameId=t.geonameId,centerOnLat=(t.north+t.south)/2,centerOnLong=(t.east+t.west)/2,mapOptions={lat:centerOnLat,lng:centerOnLong,zoom:5},map.fitBounds(polyGonLayer.getBounds()).panTo(mapOptions),country.population=parseFloat(t.population/1e6),country.countryName=t.countryName,country.currency=t.currencyCode,country.capital=t.capital,country.iso3=t.isoAlpha3,screenCheck.matches?country.flag=`https://www.countryflags.io/${country.iso2}/shiny/64.png`:country.flag=`https://www.countryflags.io/${country.iso2}/shiny/48.png`,country.area=Math.round(t.areaInSqKm).toLocaleString("en-US"),$("#titleCountry").html(country.countryName),$("#flag").attr("src",country.flag),callApi("getMoreCountryInfo",country.iso2,country.currency,saveMoreBasicData);let a=country.capital.split(" ").join("_");"New_Delhi"===a&&(a="Delhi"),callApi("getCapitalCoords",a,"",zoomToPlace)},saveMoreBasicData=e=>{country.officialName=e.officialName,country.demonym=e.demonym,country.currencyName=e.currencies.name,country.currencySymbol=e.currencies.symbol,country.languages=e.languages,callApi("getWhoData",country.iso3,"",saveWhoData)},saveWhoData=e=>{e.data.dimension[4].code[0].attr.forEach(e=>{"WORLD_BANK_INCOME_GROUP"===e.category&&(country.worldBankRating=e.value)}),country.lifeExpectancy=e.data.fact[11].value.display,displayTopLevel()},zoomToPlace=e=>{clickLocationLat=e.data.lat,clickLocationLng=e.data.lng;const t=e.sunrise;timeoffset=e.timeoffset;const a=getSunrise(t);setCurrentTime(timeoffset);let n=L.ExtraMarkers.icon({icon:"fa-star-half-alt",markerColor:"yellow",shape:"star",prefix:"fa"});capitalMarker=L.marker([clickLocationLat,clickLocationLng],{icon:n}).addTo(map).bindPopup(`The capital of ${country.countryName} is ${country.capital}. <br>${a}`),callApi("getEarthquakes",country.north,country.south,displayEarthquakes,country.east,country.west),callApi("getWiki",country.north,country.south,displayWiki,country.east,country.west),callApi("getCountryRegions",country.geonameId,"",displayRegions)},getSunrise=e=>{const t=new Date(1e3*e);return`The sun rose at ${t.getUTCHours().toString().padStart(2,0)}:${t.getUTCMinutes().toString().padStart(2,0)}:${t.getUTCSeconds().toString().padStart(2,0)}`},setCurrentTime=e=>{const t=Date.now(),a=new Date(t+1e3*e);country.currentHours=a.getUTCHours().toString(),country.currentMinutes=a.getUTCMinutes().toString().padStart(2,0)},displayPolygon=e=>{geoJsonFeature=e.data.length>1?{type:"Feature",geometry:{type:"MultiPolygon",coordinates:e.data}}:{type:"Feature",geometry:{type:"Polygon",coordinates:e.data}},(polyGonLayer=L.geoJson(geoJsonFeature,{style:{color:"#ffe135",opacity:"0.7",weight:"2"}})).addTo(map)},displayTopLevel=()=>{$("#item-A").html(country.officialName),$("#flag2").attr("src",country.flag),$("#item-B").html("Local time");let e=country.currentHours<12?"am":"pm";country.currentHours>12&&(country.currentHours=country.currentHours-12),$("#item-2").html(`${country.currentHours}:${country.currentMinutes}${e}`),$("#item-C").html("Capital"),$("#item-3").html(country.capital),$("#item-D").html("Population"),$("#item-4").html(country.population.toFixed(2)+"m"),$("#item-E").html("Area"),$("#item-5").html(`${country.area} km&sup2;`),$("#item-F").html("Inhabitants"),$("#item-6").html(country.demonym),$("#item-G").html("Languages");const t=Object.values(country.languages);if($("#item-7").html(`${t[0]}`),t.length>1)for(let e=1;e<t.length;e++)$("#item-7").append(`<br>${t[e]}`)},resetModal=()=>{$("#item-A").html(""),$("#flag2").attr("src",country.flag),$("#item-B").html(""),$("#item-2").html(""),$("#item-C").html(""),$("#item-3").html(""),$("#item-D").html(""),$("#item-4").html(""),$("#item-E").html(""),$("#item-5").html(""),$("#item-F").html(""),$("#item-6").html(""),$("#item-G").html(""),$("#item-7").html("")},getWeatherData=e=>{const t=e.data;country.weatherDescription=t.weather[0].description,country.maxtemp=Math.round(t.main.temp_max),country.mintemp=Math.round(t.main.temp_min),country.windspeed=parseFloat(t.wind.speed),country.windspeed=(2.23694*country.windspeed).toFixed(0),country.weathericon=t.weather[0].icon,country.humidity=t.main.humidity,displayWeather()},displayWeather=()=>{$("#item-A").html(`The Weather in ${country.capital}`);let e=screenCheck.matches?`https://openweathermap.org/img/wn/${country.weathericon}@2x.png`:`https://openweathermap.org/img/wn/${country.weathericon}.png`;$("#item-2").html(`<img src="${e}" alt="Weather conditions">`),$("#item-C").html("Max"),$("#item-3").html(`${country.maxtemp}&#176;C`),$("#item-D").html("Min"),$("#item-4").html(`${country.mintemp}&#176;C`),$("#item-E").html("Wind"),$("#item-5").html(`${country.windspeed} mph`),$("#item-F").html("Humidity"),$("#item-6").html(`${country.humidity}%`),$("#item-7").html(country.weatherDescription)},getVirusData=e=>{const t=e[0];country.confirmedCovidCases=t.confirmed.toLocaleString("en-US"),country.criticalCovidcases=t.critical.toLocaleString("en-US"),country.totalCovidDeaths=t.deaths.toLocaleString("en-US"),displayVirus()},displayVirus=()=>{$("#item-A").html(`Health in ${country.countryName}`),$("#item-B").html("Life expectancy"),$("#item-2").html(`${country.lifeExpectancy} years*`),$("#item-C").html("Total Covid cases"),$("#item-3").html(country.confirmedCovidCases),$("#item-D").html("Current critical Covid cases"),$("#item-4").html(country.criticalCovidcases),$("#item-E").html("Total deaths due to Covid"),$("#item-5").html(country.totalCovidDeaths),$("#item-F").html("* courtesy of World Health Organization")},getMoneyData=e=>{const t=e.data.conversion_rates;country.USDexchange=t.USD,country.EURexchange=t.EUR,displayMoney()},displayMoney=()=>{$("#item-A").html(`${country.demonym} currency (${country.currency})`),$("#item-B").html("Money"),$("#item-2").html(country.currencyName),$("#item-C").html("Symbol"),$("#item-3").html(country.currencySymbol),$("#item-D").html("World Bank rating"),$("#item-4").html(country.worldBankRating),$("#item-E").html("Exchange Rate with US $"),$("#item-5").html(country.USDexchange),$("#item-F").html("Exchange Rate with Euros &#8364;"),$("#item-6").html(country.EURexchange)},getNews=e=>{const t=e.data;t[0]&&(country.newsTitle=t[0][0],country.newsLink=t[0][1],country.newsImage=t[0][2]),t[1]&&(country.newsTitle2=t[1][0],country.newsImage2=t[1][2],country.newsLink2=t[1][1]),t[2]&&(country.newsTitle3=t[2][0],country.newsLink3=t[2][1],country.newsImage3=t[2][2]),t[4]&&(country.newsTitle4=t[3][0],country.newsLink4=t[3][1],country.newsImage4=t[3][2]),displayNews()},displayNews=()=>{$("#item-A").html("Latest News"),$("#item-B").html(`<img class="newsImage" src=${country.newsImage}>`),$("#item-2").html(`<a href=${country.newsLink} target="_blank">${country.newsTitle}</a>`),$("#item-C").html(`<img class="newsImage" src=${country.newsImage2}>`),$("#item-3").html(`<a href=${country.newsLink2} target="_blank">${country.newsTitle2}</a>`),$("#item-D").html(`<img class="newsImage" src=${country.newsImage3}>`),$("#item-4").html(`<a href=${country.newsLink3} target="_blank">${country.newsTitle3}</a>`),$("#item-E").html(`<img class="newsImage" src=${country.newsImage4}>`),$("#item-5").html(`<a href=${country.newsLink4} target="_blank">${country.newsTitle4}</a>`)},displayEarthquakes=e=>{let t,a;e.data.earthquakes.map(e=>{switch(!0){case e.magnitude<4:t="Minor",a="green";break;case e.magnitude<6:t="Moderate",a="orange";break;case e.magnitude<8:t="Major",a="red";break;case e.magnitude<10:t="Catastrophic",a="black";break;default:t="Recorded"}let n=new Date(e.datetime),o=L.ExtraMarkers.icon({icon:"fa-compress-alt",markerColor:a,shape:"penta",prefix:"fa"}),r=L.marker([e.lat,e.lng],{icon:o}).bindPopup(`${t} earthquake in ${n.getFullYear()} - magnitude ${e.magnitude}`);earthquakeMarkers.addLayer(r)}),earthquakeMarkerLayer=earthquakeMarkers.addTo(map)},displayWiki=e=>{e.data.geonames.map(e=>{let t=L.ExtraMarkers.icon({icon:"fa-info-circle",markerColor:"cyan",shape:"square",prefix:"fa"}),a=L.marker([e.lat,e.lng],{icon:t}).bindPopup(`<strong>${e.title}</strong><br>${e.summary}<br><a href=${e.wikipediaUrl}>Wiki Link</a>`);wikiMarkers.addLayer(a)}),wikiMarkerLayer=wikiMarkers.addTo(map)},displayRegions=e=>{e.data.map(e=>{let t=L.ExtraMarkers.icon({icon:"fa-map-marked-alt",markerColor:"dark-orange",shape:"penta",prefix:"fa"}),a=L.marker([e.lat,e.lng],{icon:t}).bindPopup(`<strong>${e.adminName1}</strong><br>population ${e.population.toLocaleString("en-US")}`);regionMarkers.addLayer(a)}),regionMarkerLayer=regionMarkers.addTo(map)},resetMap=()=>{map.removeLayer(polyGonLayer),wikiMarkerLayer.clearLayers(),regionMarkerLayer.clearLayers(),earthquakeMarkerLayer.clearLayers(),capitalMarker.remove(),youAreHereMarker.remove(),circleMarker.remove(),wikiMarkers.remove(),earthquakeMarkers.remove(),regionMarkers.remove()},callApi=(e,t,a,n,o,r)=>{const i=`libs/php/${e}.php`;$.ajax({url:i,type:"POST",dataType:"json",data:{param1:t,param2:a,param3:o,param4:r},success:function(e){n(e)},error:function(e,t,a){console.log(`${i}: ajax call failed ${t}`)}})};