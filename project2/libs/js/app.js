let staticResults,searchDept,searchLoc,newEmployee={firstName:"",lastName:"",department:"Choose Department",departmentID:"reset",location:"Choose Location",locationID:"reset",email:"",id:"not assigned"},results=[],searchResults=[],locations=[],departments=[],departmentOptions=[],validateString="";$(document).ready(function(){initialiseData()});const initialiseData=()=>{callApi("getAll","GET",displayStaffData),callApi("getAllDepartments","GET",getDepartmentData),callApi("getAllLocations","GET",getLocationData)},displayStaffData=e=>{e.data?(staticResults=e.data,results=e.data):results=e,$("#firstRow").html(""),results.forEach(e=>{$("#firstRow").append(`<tr key=${e.id}>\n    <td class="bigger">\n             <p id="nameData"><strong>${e.firstName} ${e.lastName.toUpperCase()}</strong></p>\n    </td>\n    <td class="bigger">\n             <p id="departmentData">${e.department}</p>\n    </td>\n    <td class="bigger">\n             <p id="locationData">${e.location}</p>\n    </td>\n    <td class="smaller">         \n         <div class="buttons">\n         <button class="btn btn-secondary" type="button" id="view${e.id}"><i class="far fa-eye"></i></button>\n         <button class="btn btn-outline-dark" type="button" id="edit${e.id}"><i class="far fa-edit"></i></button>\n         <button class="btn btn-primary" type="button" id="delete${e.id}" ><i class="far fa-trash-alt"></i></button>\n        </div>  \n    </td>\n     </tr>`),$("#firstRow").on("click",`#view${e.id}`,function(){$(".viewEmployee").show(viewStaff(e.id))}),$("#firstRow").on("click",`#edit${e.id}`,function(){$(".addEditForm").show(editStaff(e.id))}),$("#firstRow").on("click",`#delete${e.id}`,function(){$(".viewEmployee").show(deleteStaff(e.id))})})},getDepartmentData=e=>{departments=e.data,$("#selectDept").html('<option value="reset" selected>Search department</option>'),departments.forEach(e=>{$("#selectDept").append(`<option value="${e.id}">${e.name}</option>`)})},getLocationData=e=>{locations=e.data,$("#selectLoc").html('<option value="reset" selected>Search location</option>'),locations.forEach(e=>{$("#selectLoc").append(`<option value="${e.name}">${e.name}</option>`)})},callApi=(e,t,a,o,n,l,i,s)=>{$("#validation-text").html("");const r=`libs/php/${e}.php`;$.ajax({url:r,type:t,dataType:"json",data:{param1:o,param2:n,param3:l,param4:i,param5:s},crossOrigin:"",success:function(e){a(e)},error:function(e,t,a){console.log(`${r}: ajax call failed ${t}. ${a}. ${e}`)}})};$(".close").click(function(e){closeModal()});const closeModal=()=>{$("#validation-text").html(""),$(".modal").modal("hide"),$(".addEditForm").hide(),$(".viewEmployee").hide(),$(".newDepartmentForm").hide(),$(".newLocationForm").hide()};$("#hidingAddButton").click(function(){$(".addButtons").toggle()}),$("#hidingSearchButton").click(function(){$(".thead-light").toggle(),$("#resetHidingButton").toggle()});const viewStaff=e=>{let t=staticResults.filter(t=>t.id===e);$("#wholeName").html(`<strong>${t[0].firstName} ${t[0].lastName}</strong>`),$("#viewDepartment").html(`${t[0].department} department`),$("#viewLocation").html(`The ${t[0].location} office`),$("#emailFont").html(`${t[0].email}`),$("#staffid").html(`Employee ID ${t[0].id}`),$("#extraInfo").modal("show")},editStaff=e=>{let t=results.filter(t=>t.id===e),a=locations.find(e=>e.name===t[0].location);t[0].locationID=a.id,buildForm(t[0],"Edit","Save Changes"),$("#forename").val(t[0].firstName),$("#surname").val(t[0].lastName),$("#modalSelectLoc").val(t[0].locationID),$("#modalSelectDept").val(t[0].departmentID),$("#email").val(t[0].email),newEmployee.id=t[0].id,$("#extraInfo").modal("show")},deleteStaff=e=>{viewStaff(e),$("#validation-text").html('<div class="alert alert-warning">\n  <strong>Are you sure you want to delete this employee?</strong><br>\n  <button class="btn btn-primary" id="confirmDelete">Delete</button>\n  <button class="btn btn-outline-dark close">Cancel</button>'),$(".close").on("click",function(){closeModal()}),$("#confirmDelete").on("click",function(){resetData(),callApi("deletePersonnelByID","GET",deleteConfirmation,e)})},deleteConfirmation=e=>{initialiseData(),$("#validation-text").html('<div class="alert alert-success">\n  <strong>Employee successfully deleted</strong><br>'),$("#extraInfo").modal("show")};$("#addStaff").click(function(e){e.preventDefault(),$("#forename").val(" "),$("#surname").val(" "),$("#modalSelectLoc").val("reset"),$("#modalSelectDept").val("reset"),$("#email").val(" "),$("#staffid").val("Not assigned"),newEmployee.id="not assigned",buildForm(newEmployee,"Add","Add Employee"),$(".addEditForm").show(),$("#extraInfo").modal("show")});const buildForm=(e,t,a)=>{$("#verb").html(t),$("#addEditButton").html(`${a}`),$("#employeeid").html(`Employee ID #${e.id}`),$("#modalSelectLoc").html('<option value="reset" selected>Choose location</option>'),locations.forEach(e=>{$("#modalSelectLoc").append(`<option value="${e.id}">${e.name}</option>`)}),$("#modalSelectDept").html('<option value="reset" selected>Choose department</option>'),departments.forEach(e=>{$("#modalSelectDept").append(`<option value="${e.id}">${e.name}</option>`)}),$("#modalSelectDept").change(function(e){let t=e.currentTarget.value;if("reset"!==t&&"resetSubset"!==t){let e=departments.find(e=>e.id===t);$("#modalSelectLoc").val(e.locationID)}else"reset"===t&&$("#modalSelectLoc").val("reset")}),$("#modalSelectLoc").change(function(e){let t=e.currentTarget.value;"reset"===t?departments.forEach(e=>{$("#modalSelectDept").append(`<option value="${e.id}">${e.name}</option>`)}):(departmentOptions=departments.filter(e=>e.locationID===t),$("#modalSelectDept").html(""),departmentOptions.length>1&&$("#modalSelectDept").append('<option value="resetSubset">Choose department</option>'),departmentOptions.forEach(e=>{$("#modalSelectDept").append(`<option value="${e.id}">${e.name}</option>`)}))})};$("#addDept").click(function(e){e.preventDefault(),$("#newDepartment").val(""),$("#selectDeptLocation").html('<option value="reset" selected>Choose location</option>'),locations.forEach(e=>{$("#selectDeptLocation").append(`<option value="${e.id}" loc-name="${e.name}">${e.name}</option>`)}),$(".newDepartmentForm").show(),$("#extraInfo").modal("show")}),$("#addNewDepartment").on("click",function(){let e=$("#newDepartment").val().toLowerCase().replace(/(\b[a-z](?!\s))/g,function(e){return e.toUpperCase()});validateField("new department",e,2,20,lastDepartmentCheck)});const lastDepartmentCheck=e=>{let t=$("#selectDeptLocation").val();if("reset"===t)validationWarning(validateString="The new department must be associated with a location");else if(departments.find(t=>t.name===e))validationWarning(validateString=`${e} already exists within Company Directory. Duplicates are not allowed.`);else{let a=locations.find(e=>e.id===t).name;callApi("insertDepartment","GET",getNewDeptConfirmation,e,t,a)}};$("#addLoc").click(function(e){e.preventDefault(),$("#newLocation").val(""),$(".newLocationForm").show(),$("#extraInfo").modal("show")}),$("#addNewLocation").on("click",function(){let e=$("#newLocation").val().toLowerCase().replace(/(\b[a-z](?!\s))/g,function(e){return e.toUpperCase()});validateField("new location",e,2,20,lastLocationCheck)});const lastLocationCheck=e=>{locations.find(t=>t.name===e)?validationWarning(validateString=`${e} already exists within Company Directory. Duplicates are not allowed.`):callApi("insertLocation","GET",getNewLocConfirmation,e)},getNewLocConfirmation=e=>{initialiseData(),closeModal(),$("#validation-text").html(`<div class="alert alert-success"><strong>${e.data} has successfully been added to the Company Directory. <br>Please add departments for this location.</strong></div>`),$("#extraInfo").modal("show")},getNewDeptConfirmation=e=>{initialiseData(),closeModal(),$("#extraInfo").modal("show"),$("#validation-text").html(`<div class="alert alert-success"><strong>${e.data}</strong></div>`)};$("#searchNames").on("input",function(e){let t=e.currentTarget.value.toLowerCase(),a="reset"===$("#selectDept").val()&&"reset"===$("#selectLoc").val()?staticResults:searchResults;results=a.filter(e=>(e.wholeName=e.firstName.toLowerCase()+e.lastName.toLowerCase(),e.wholeName.includes(t))),displayStaffData(results)}),$("#selectDept").on("change",function(e){if("reset"===(searchDept=e.currentTarget.value));else{results=results.filter(e=>e.departmentID===searchDept),searchResults=results,displayStaffData(results)}}),$("#selectLoc").on("change",function(e){if("reset"===(searchLoc=e.currentTarget.value))resetData();else{results=results.filter(e=>e.location===searchLoc),searchResults=results,displayStaffData(results)}});const resetData=()=>{displayStaffData(staticResults),$("#searchNames").val(""),$("#selectDept").val("reset"),$("#selectLoc").val("reset"),newEmployee={firstName:"",lastName:"",department:"Choose Department",departmentID:"reset",location:"Choose Location",locationID:"reset",email:"",id:"not assigned"}};$("#resetButton").click(function(){resetData()}),$("#resetHidingButton").click(function(){resetData()}),$("#addOrEditStaff").click(function(){newEmployee.firstName=$("#forename").val().toLowerCase().replace(/(\b[a-z](?!\s))/g,function(e){return e.toUpperCase()}),validateField("employee's first name",newEmployee.firstName,2,15,lastNameCheck)});const lastNameCheck=e=>{newEmployee.lastName=$("#surname").val().toLowerCase().replace(/(\b[a-z](?!\s))/g,function(e){return e.toUpperCase()}),validateField("employee's last name",newEmployee.lastName,2,20,departmentCheck)},departmentCheck=()=>{newEmployee.departmentID=$("#modalSelectDept").val(),newEmployee.locationID=$("#modalSelectLoc").val(),"reset"!==newEmployee.departmentID&&"reset"!==newEmployee.locationID?(newEmployee.email=$("#email").val().toLowerCase(),"not assigned"!==newEmployee.id?validateField("email",newEmployee.email,6,40,updatePersonnel):validateField("email",newEmployee.email,6,40,emailDuplicationCheck)):validationWarning(validateString="The employee must be associated with a location and a department")},emailDuplicationCheck=()=>{staticResults.find(e=>e.email===newEmployee.email)?validationWarning(validateString="There is already an employee with this email address in the Company Directory. Duplicates are not allowed"):callApi("insertEmployee","POST",getAddConfirmation,newEmployee.firstName,newEmployee.lastName,newEmployee.email,newEmployee.departmentID)},updatePersonnel=()=>{callApi("updateEmployee","GET",getEditConfirmation,newEmployee.firstName,newEmployee.lastName,newEmployee.email,newEmployee.departmentID,newEmployee.id)},getAddConfirmation=e=>{closeModal(),initialiseData(),$("#validation-text").html(`<div class="alert alert-success">\n  <strong>${e.data[0]}</strong><br></div>`),$("#extraInfo").modal("show")},getEditConfirmation=e=>{closeModal(),initialiseData(),$("#validation-text").html(`<div class="alert alert-success">\n  <strong>${e.data[0]}'s information has successfully been updated</strong><br></div>`),$("#extraInfo").modal("show")},validationWarning=e=>{$("#validation-text").html(""),$("#validation-text").html(`<div class="alert alert-danger">\n      <strong><p>Error!</p></strong> ${e} \n    </div>`)},validateField=(e,t,a,o,n)=>{t.length>o||t.length<a?validationWarning(validateString=`The ${e} must be between ${a} and ${o} characters.`):validatePattern(e,t,n)},validatePattern=(e,t,a)=>{"email"===e?t.match(/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)?a(t):validationWarning(validateString=`${t} does not seem to be a regularly formatted email address.`):t.match(/^[A-Za-z -]+$/)?a(t):validationWarning(validateString=`The ${e} must not contain any unusual characters.`)};